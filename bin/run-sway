#!/bin/sh

set -e
set -u

readonly default_bar_command="qbar server"
readonly executable_name=qbar
readonly sway_bar_id=bar-0

stack build

readonly temp_dir=$(mktemp -d)
readonly stderr=$temp_dir/stderr
mkfifo $stderr

trap "swaymsg bar $sway_bar_id status_command $default_bar_command; rm -rf $temp_dir" EXIT INT HUP TERM

swaymsg bar $sway_bar_id status_command "exec $(stack path --local-install-root)/bin/$executable_name $@ -- server 2> $stderr"

# show output and run forever (use Ctrl-C to stop)
cat $stderr
